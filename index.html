<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAIXÃOFLIX IPTV</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e50914; --bg: #0a0a0a; --side-bg: #141414; --text: #eee; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Menu Lateral */
        #sidebar { 
            width: 300px; background: var(--side-bg); display: flex; flex-direction: column; 
            border-right: 1px solid #222; z-index: 100;
        }
        .search-area { padding: 20px; background: #000; }
        .search-box { 
            width: 100%; padding: 10px; border-radius: 5px; border: none; 
            background: #333; color: white; box-sizing: border-box; outline: none;
        }
        #channel-list { overflow-y: auto; flex-grow: 1; scrollbar-width: thin; scrollbar-color: var(--primary) #141414; }
        .cat-section { border-bottom: 1px solid #222; }
        .cat-header { 
            padding: 12px 20px; background: #1a1a1a; font-size: 13px; 
            font-weight: bold; color: #888; text-transform: uppercase; cursor: pointer;
            display: flex; justify-content: space-between;
        }
        .channel-item { 
            padding: 10px 20px; font-size: 14px; cursor: pointer; transition: 0.2s; 
            display: flex; align-items: center; gap: 10px; border-left: 3px solid transparent;
        }
        .channel-item:hover { background: #222; border-left: 3px solid var(--primary); }
        .channel-item img { width: 35px; height: 35px; object-fit: contain; border-radius: 4px; background: #000; }

        /* Área do Player */
        #main-content { flex-grow: 1; display: flex; flex-direction: column; position: relative; background: #000; }
        #player-wrapper { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #000; }
        video { width: 100%; height: auto; max-height: 100%; aspect-ratio: 16/9; box-shadow: 0 0 50px rgba(0,0,0,1); }
        
        .overlay-info { 
            position: absolute; bottom: 0; left: 0; right: 0; padding: 40px 5%; 
            background: linear-gradient(transparent, rgba(0,0,0,0.9)); pointer-events: none;
        }
        #current-title { font-size: 28px; font-weight: bold; margin: 0; color: #fff; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; height: 40%; }
            #main-content { height: 60%; }
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="search-area">
        <div style="color:var(--primary); font-weight:bold; font-size:22px; margin-bottom:15px;">PAIXÃOFLIX</div>
        <input type="text" id="searchInput" class="search-box" placeholder="Procurar canal..." onkeyup="filterChannels()">
    </div>
    <div id="channel-list">
        <div style="padding: 20px; text-align: center; color: #666;">Carregando lista...</div>
    </div>
</div>

<div id="main-content">
    <div id="player-wrapper">
        <video id="video" controls autoplay playsinline></video>
    </div>
    <div class="overlay-info">
        <p id="current-title">Selecione um canal</p>
    </div>
</div>

<script>
    const TMDB_KEY = 'b275ce8e1a6b3d5d879bb0907e4f56ad';
    const m3uUrl = '/tv.paixaoflix.m3u?cache=' + Date.now();
    const video = document.getElementById('video');
    let allData = {};

    async function init() {
        try {
            const res = await fetch(m3uUrl);
            const text = await res.text();
            if(!text.includes('#EXTINF')) throw new Error();
            parseM3U(text);
        } catch (e) {
            document.getElementById('channel-list').innerHTML = `<div style="padding:20px; color:red;">Erro ao carregar lista.</div>`;
        }
    }

    function parseM3U(data) {
        const lines = data.split('\n');
        let categories = {};
        for (let i = 0; i < lines.length; i++) {
            if (lines[i].includes('#EXTINF')) {
                const title = lines[i].split(',')[1]?.trim() || "Sem Nome";
                const url = lines[i+1]?.trim();
                const group = lines[i].match(/group-title="([^"]+)"/)?.[1] || "CANAIS";
                if (url && url.startsWith('http')) {
                    if (!categories[group]) categories[group] = [];
                    categories[group].push({ title, url });
                }
            }
        }
        allData = categories;
        render(categories);
    }

    function render(categories) {
        const list = document.getElementById('channel-list');
        list.innerHTML = '';
        for (let cat in categories) {
            const section = document.createElement('div');
            section.className = 'cat-section';
            section.innerHTML = `<div class="cat-header">${cat} <span>▼</span></div>`;
            
            const chanContainer = document.createElement('div');
            categories[cat].forEach(item => {
                const chan = document.createElement('div');
                chan.className = 'channel-item';
                const safeId = btoa(unescape(encodeURIComponent(item.title))).substring(0,8).replace(/[^a-z]/gi, 'x');
                chan.innerHTML = `<img src="https://via.placeholder.com/100x100/222/555?text=TV" id="img-${safeId}"> <span>${item.title}</span>`;
                chan.onclick = () => playStream(item.url, item.title);
                chanContainer.appendChild(chan);
                
                fetchLogo(item.title, safeId, cat);
            });
            section.appendChild(chanContainer);
            list.appendChild(section);
        }
    }

    async function fetchLogo(title, id, category) {
        // Se for canal de TV aberta/fechada, busca logos. Se for filme/série, busca posters.
        let q = title.replace(/E\.P\.C/gi, 'Eu a Patroa e as Crianças').replace(/S\d+E\d+|720p|1080p|HD|By-.*/gi, '').trim();
        try {
            const r = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${TMDB_KEY}&language=pt-BR&query=${encodeURIComponent(q)}`);
            const j = await r.json();
            if (j.results && j.results[0]?.poster_path) {
                document.getElementById(`img-${id}`).src = `https://image.tmdb.org/t/p/w200${j.results[0].poster_path}`;
            }
        } catch (e) {}
    }

    function playStream(url, title) {
        document.getElementById('current-title').innerText = title;
        // Tenta usar o proxy do Worker para links HTTP
        let finalUrl = url.startsWith('http:') ? `/proxy?url=${encodeURIComponent(url)}` : url;
        
        if (Hls.isSupported()) {
            const hls = new Hls({ xhrSetup: function(xhr) { xhr.withCredentials = false; } });
            hls.loadSource(finalUrl);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(() => {}));
            hls.on(Hls.Events.ERROR, function (event, data) {
                if (data.fatal) console.error("Erro fatal no HLS");
            });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = finalUrl;
            video.play();
        }
    }

    function filterChannels() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        let filtered = {};
        for (let cat in allData) {
            let matches = allData[cat].filter(i => i.title.toLowerCase().includes(q));
            if (matches.length > 0) filtered[cat] = matches;
        }
        render(filtered);
    }

    init();
</script>
</body>
</html>
