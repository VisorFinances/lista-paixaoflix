<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>PaixãoFlix – Web TV</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="favicon.ico">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8"></script>

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:Poppins;
  display:flex;
  height:100vh;
  overflow:hidden
}

/* SIDEBAR */
#side{
  width:320px;
  background:#111;
  overflow:auto
}

#side button{
  width:33%;
  padding:10px;
  border:0;
  background:#222;
  color:#fff;
  margin:0 2px;
  border-radius:4px;
  cursor:pointer
}

#side button.active{
  background:#e50914
}

#list{
  position:relative
}

.item{
  padding:10px;
  border-bottom:1px solid #222;
  cursor:pointer;
  font-size:13px;
}

.item.active{
  background:#1a1a1a;
  border-left:4px solid #e50914;
}

/* PLAYER */
#player{
  flex:1;
  background:#000;
  position:relative
}

video{
  width:100%;
  height:100%
}

#error{
  position:absolute;
  color:#fff;
  background:#000c;
  padding:20px;
  display:none;
  z-index:5
}

/* OVERLAY NETFLIX */
#overlay{
  position:absolute;
  right:0;
  bottom:0;
  width:45%;
  padding:30px;
  background:linear-gradient(to left, rgba(0,0,0,0.9), transparent);
  z-index:4;
  display:none;
}

#overlay h1{
  font-size:26px;
  margin:0 0 10px 0;
  font-weight:700
}

#overlay p{
  font-size:14px;
  opacity:0.85;
  max-width:90%
}

#assistindo{
  padding:10px;
  font-size:13px;
  border-bottom:1px solid #222;
  display:none
}
</style>
</head>

<body>

<div id="side">
  <div>
    <button id="f" class="active">FILMES</button>
    <button id="s">SÉRIES</button>
    <button id="t">TV</button>
  </div>

  <div id="assistindo"></div>
  <div id="list"></div>
</div>

<div id="player">
  <div id="error"></div>

  <!-- OVERLAY -->
  <div id="overlay">
    <h1 id="ov-title"></h1>
    <p id="ov-desc"></p>
  </div>

  <video id="video" controls autoplay playsinline></video>
</div>

<script>
const video = document.getElementById('video');
const list = document.getElementById('list');
const errorBox = document.getElementById('error');
const overlay = document.getElementById('overlay');
const ovTitle = document.getElementById('ov-title');
const ovDesc = document.getElementById('ov-desc');
const assistindo = document.getElementById('assistindo');

let hls;
let currentItems = [];
let currentIndex = 0;
let currentMode = 'filmes';
let overlayTimer;

/* ERROS */
function showError(msg){
  errorBox.style.display='block';
  errorBox.innerText=msg;
}

function clearError(){
  errorBox.style.display='none';
}

/* OVERLAY */
function showOverlay(title, desc){
  ovTitle.innerText = title || '';
  ovDesc.innerText = desc || '';
  overlay.style.display = 'block';

  clearTimeout(overlayTimer);
  overlayTimer = setTimeout(()=>{
    overlay.style.display='none';
  },2000);
}

function hideOverlay(){
  overlay.style.display='none';
}

/* PLAYER */
function play(url, title){
  hideOverlay();
  assistindo.style.display='block';
  assistindo.innerText = 'Assistindo agora: ' + title;

  clearError();
  if(hls){hls.destroy();hls=null;}

  try{
    if(url.endsWith('.m3u8')){
      if(Hls.isSupported()){
        hls=new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.ERROR,()=>showError("Canal bloqueado pelo provedor (CORS)"));
      }else{
        video.src=url;
      }
    }else{
      video.src=url;
    }
    video.play();
  }catch(e){
    showError("Este conteúdo não pode ser reproduzido");
  }
}

/* RENDER LISTA */
function renderList(){
  list.innerHTML='';
  currentItems.forEach((item,i)=>{
    const d=document.createElement('div');
    d.className='item';
    d.innerText=item.title;
    if(i===currentIndex) d.classList.add('active');

    d.onclick=()=>{
      currentIndex=i;
      updateSelection();
      play(item.url,item.title);
    };

    d.onmouseenter=()=>{
      if(currentMode!=='tv'){
        showOverlay(item.title,item.desc||'');
      }
    };

    list.appendChild(d);
  });
}

/* SELEÇÃO */
function updateSelection(){
  document.querySelectorAll('.item').forEach((el,i)=>{
    el.classList.toggle('active', i===currentIndex);
  });

  const item=currentItems[currentIndex];
  if(item && currentMode!=='tv'){
    showOverlay(item.title,item.desc||'');
  }
}

/* FILMES */
async function loadFilmes(){
  currentMode='filmes';
  document.getElementById('f').classList.add('active');
  document.getElementById('s').classList.remove('active');
  document.getElementById('t').classList.remove('active');

  const data = await fetch('./data/filmes.json').then(r=>r.json()).catch(()=>[]);
  currentItems = data.map(f=>({
    title:f.titulo,
    url:f.url,
    desc:f.descricao || 'Filme disponível no PaixãoFlix'
  }));
  currentIndex=0;
  renderList();
  updateSelection();
}

/* SERIES */
async function loadSeries(){
  currentMode='series';
  document.getElementById('s').classList.add('active');
  document.getElementById('f').classList.remove('active');
  document.getElementById('t').classList.remove('active');

  const data = await fetch('./data/series.json').then(r=>r.json()).catch(()=>[]);
  currentItems=[];
  data.forEach(s=>{
    (s.episodios||[]).forEach(e=>{
      currentItems.push({
        title:s.nome+' - '+e.titulo,
        url:e.url,
        desc:s.descricao || 'Episódio disponível'
      });
    });
  });
  currentIndex=0;
  renderList();
  updateSelection();
}

/* TV */
async function loadTV(){
  currentMode='tv';
  document.getElementById('t').classList.add('active');
  document.getElementById('f').classList.remove('active');
  document.getElementById('s').classList.remove('active');

  const txt = await fetch('./data/canais.m3u').then(r=>r.text()).catch(()=>null);
  currentItems=[];
  if(!txt){showError("Lista IPTV indisponível");return;}

  let name='';
  txt.split('\n').forEach(l=>{
    if(l.startsWith('#EXTINF')) name=l.split(',').pop();
    else if(l.startsWith('http')){
      currentItems.push({title:name,url:l.trim()});
    }
  });

  currentIndex=0;
  renderList();
}

/* BOTÕES */
document.getElementById('f').onclick=loadFilmes;
document.getElementById('s').onclick=loadSeries;
document.getElementById('t').onclick=loadTV;

/* SETAS */
document.addEventListener('keydown',e=>{
  if(e.key==='ArrowDown'){
    currentIndex=Math.min(currentIndex+1,currentItems.length-1);
    updateSelection();
  }
  if(e.key==='ArrowUp'){
    currentIndex=Math.max(currentIndex-1,0);
    updateSelection();
  }
  if(e.key==='Enter'){
    const item=currentItems[currentIndex];
    if(item) play(item.url,item.title);
  }
});

/* INIT */
loadFilmes();
</script>

</body>
</html>
