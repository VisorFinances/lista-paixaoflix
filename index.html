<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Paix√£oFlix ‚Äì WebTV</title>
<meta name="theme-color" content="#C0C0C0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --sidebar:#C0C0C0;
  --btn:#363636;
  --ativo:#033f99;
  --font:16px;
  --pop:'Poppins',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:var(--pop);font-size:var(--font);-webkit-tap-highlight-color:transparent;}
body{display:flex;height:100vh;overflow:hidden;background:#000;color:#fff;}
/* ---------- SIDE BAR ---------- */
.sidebar{position:fixed;left:0;top:0;width:240px;height:100vh;background:var(--sidebar);display:flex;flex-direction:column;align-items:center;padding:10px;z-index:10;}
.sidebar img.logo{width:180px;margin-bottom:8px;}
.sidebar .clock{color:#000;font-weight:600;margin-bottom:12px;text-align:center;}
.sidebar input.search{width:100%;padding:8px;border-radius:6px;border:none;margin-bottom:14px;}
.sidebar .menu{flex:1;width:100%;}
.sidebar .menu .item{width:100%;display:flex;align-items:center;padding:10px 8px;margin:4px 0;background:var(--btn);color:#fff;border-radius:6px;cursor:pointer;transition:.2s;box-shadow:0 3px 6px rgba(0,0,0,.4);}
.sidebar .menu .item:hover,.sidebar .menu .item.focus{transform:scale(1.03);box-shadow:0 0 12px var(--ativo);}
.sidebar .menu .item.ativo{background:var(--ativo);}
.sidebar .menu .item img.ico{width:22px;margin-right:10px;filter:invert(1);}
.sidebar .exit-btn{width:100%;padding:10px;margin-top:auto;background:var(--btn);color:#fff;border-radius:6px;border:none;cursor:pointer;transition:.2s;}
.sidebar .exit-btn:hover{transform:scale(1.05);}
/* ---------- MAIN ---------- */
.main{flex:1;height:100vh;display:flex;flex-direction:column;margin-left:240px;background:#111;}
.loader{position:fixed;inset:0;background:#000;displayFlex;align-items:center;justify-content:center;z-index:9999;}
.loader img{width:240px;max-width:90vw;}
/* ---------- CONTENT ---------- */
.content{flex:1;padding:14px;overflow-y:auto;display:none;grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(154px,1fr));}
.card{position:relative;background:#222;border-radius:8px;cursor:pointer;transition:.2s;}
.card:hover,.card.focus{transform:scale(1.05);box-shadow:0 0 12px var(--ativo);}
.card img.poster{width:100%;border-radius:8px 8px 0 0;display:block;}
.card .info{padding:6px 8px;font-size:13px;color:#ccc;}
.card .info .year-rating{display:flex;justify-content:space-between;}
/* ---------- PLAYER ---------- */
.player-wrapper{position:fixed;inset:0;background:#000;display:none;flex-direction:column;z-index:20;}
.player-wrapper .player-top{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;}
.player-wrapper .exit-player{background:var(--btn);color:#fff;padding:6px 12px;border-radius:4px;border:none;cursor:pointer;opacity:0;transition:opacity .3s;}
.player-wrapper.active .exit-player{opacity:1;}
.player-wrapper video{width:100%;flex:1;background:#000;}
/* ---------- CATEG FLOAT ---------- */
.cat-float{position:absolute;top:60px;left:260px;background:#222;padding:10px;border-radius:8px;display:none;grid-template-columns:repeat(3,1fr);gap:8px;z-index:15;}
.cat-float.show{display:grid;}
.cat-float button{background:var(--btn);color:#fff;padding:8px 14px;border:none;border-radius:4px;cursor:pointer;}
.cat-float button.ativo{background:var(--ativo);}
/* ---------- HELPERS ---------- */
.pulse{animation:pulse 1.2s infinite;}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@media(max-width:900px){
  body{flex-direction:column;}
  .sidebar{position:relative;width:100%;height:auto;flex-direction:row;flex-wrap:wrap;padding:6px;}
  .sidebar img.logo{width:120px;}
  .sidebar input.search{width:40%;}
  .sidebar .menu{display:flex;overflow-x:auto;padding:4px 0;}
  .sidebar .menu .item{min-width:110px;margin:0 4px;}
  .main{margin-left:0;}
  .cat-float{left:10px;right:10px;}
}
@media(orientation:portrait) and (max-width:900px){
  body transform rotate(90deg); /* for√ßa landscape ‚Äì alguns smartTVs respeitam */
}
</style>
</head>
<body>
<!-- ---------- LOADER ---------- -->
<div class="loader" id="loader">
  <img src="https://raw.githubusercontent.com/VisorFinances/lista-paixaoflix/refs/heads/main/logoof512.png" alt="Logo">
</div>

<!-- ---------- SIDE BAR ---------- -->
<aside class="sidebar">
  <img class="logo" src="https://raw.githubusercontent.com/VisorFinances/lista-paixaoflix/refs/heads/main/logoof512.png" alt="Paix√£oFlix">
  <div class="clock" id="clock"></div>
  <input class="search" id="globalSearch" placeholder="Pesquisar...">
  <nav class="menu" id="menu"></nav>
  <button class="exit-btn" id="exitBtn">Sair</button>
</aside>

<!-- ---------- MAIN ---------- -->
<main class="main">
  <div class="cat-float" id="catFloat"></div>
  <section class="content" id="content"></section>
</main>

<!-- ---------- PLAYER ---------- -->
<div class="player-wrapper" id="playerWrap">
  <div class="player-top">
    <span id="playerTitle"></span>
    <button class="exit-player" id="exitPlayer">Sair do player</button>
  </div>
  <video id="player" controls autoplay></video>
</div>

<script>
/* ========== UTILS & CACHE ========== */
const $ = q => document.querySelector(q);
const $$ = q => document.querySelectorAll(q);
const LS = k => JSON.parse(localStorage.getItem(k)||'[]');
const SS = (k,v) => localStorage.setItem(k,JSON.stringify(v));
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const rand = () => Math.random().toString(36).slice(2);

/* ========== CONFIGS ========== */
const ENDPOINTS = {
  tv:        'https://raw.githubusercontent.com/VisorFinances/lista-paixaoflix/main/data/ativa_canais.m3u',
  fav:       'https://raw.githubusercontent.com/VisorFinances/lista-paixaoflix/main/data/favoritos.json',
  filme:     'https://raw.githubusercontent.com/VisorFinances/lista-paixaoflix/main/data/filmes.json',
  serie:     'https://raw.githubusercontent.com/VisorFinances/lista-paixaoflix/main/data/series.json',
  kidsCanais:'https://raw.githubusercontent.com/VisorFinances/lista-paixaoflix/main/data/ativa_kids_canais.m3u',
  kidsFilme: 'https://raw.githubusercontent.com/VisorFinances/lista-paixaoflix/main/data/kids_filmes.json',
  kidsSerie: 'https://raw.githubusercontent.com/VisorFinances/lista-paixaoflix/main/data/kids_filmes.json'
};
const CATS = ['A√ß√£o','Aventura','Com√©dia','Drama','Nacional','Romance','Religioso','Fic√ß√£o','Anime','Anima√ß√£o','Cl√°ssicos','Dorama','Suspense','Policial','Crime','Terror','Document√°rios','Faroeste','Musical','Adulto'];
const ICONS = {tv:'üì∫',fav:'‚≠ê',cont:'‚è±Ô∏è',filme:'üé¨',serie:'üìΩÔ∏è',kidsCanais:'üë∂üì∫',kidsFilme:'üë∂üé¨',kidsSerie:'üë∂üìΩÔ∏è'};

/* ========== DATA ========== */
let DATA = {};          // tudo carregado
let CUR = '';           // se√ß√£o ativa
let FOCUS = null;       // elemento focado
let PLAYER = $('#player');
let PLAYER_WRAP = $('#playerWrap');
let CONTINUE = LS('continue'); // hist√≥rico 24h

/* ========== START ========== */
window.addEventListener('DOMContentLoaded',async()=>{
  $('#loader').style.display='flex';
  await loadAll();
  renderMenu();
  hookEvents();
  startClock();
  await sleep(900);
  $('#loader').style.display='none';
  route('tv'); // inicial
});

/* ========== LOAD ALL ========== */
async function loadAll(){
  const promises = Object.keys(ENDPOINTS).map(async k=>{
    const url = ENDPOINTS[k];
    if(url.endsWith('.m3u')||url.endsWith('.m3u')){
      const txt = await fetch(url).then(r=>r.text());
      DATA[k] = parseM3U(txt);
    }else{
      DATA[k] = await fetch(url).then(r=>r.json());
    }
  });
  await Promise.all(promises);
}

function parseM3U(raw){
  const lines = raw.split('\n');
  const items=[];
  let obj={};
  for(let ln of lines){
    ln=ln.trim();
    if(ln.startsWith('#EXTINF:')){
      const name = ln.split('tvg-name=')[1]?.split('"')[1]||'Sem nome';
      const logo = ln.split('tvg-logo=')[1]?.split('"')[1]||'';
      obj={name,logo,url:''};
    }else if(ln && !ln.startsWith('#') && obj.name){
      obj.url=ln; items.push(obj); obj={};
    }
  }
  return items;
}

/* ========== MENU ========== */
function renderMenu(){
  const nav=$('#menu');
  nav.innerHTML='';
  for(const[k,v] of Object.entries(ICONS)){
    const div=document.createElement('div'); div.className='item'; div.tabIndex=0;
    div.innerHTML=`<img class=ico src="${ICONS[k]}" hidden><span>${v} ${label(k)}</span>`;
    div.dataset_key=k;
    nav.appendChild(div);
  }
}

function label(k){
  return {tv:'TV ao vivo',fav:'Favoritos',cont:'Continue assistindo',filme:'Cinema',serie:'S√©ries',kidsCanais:'Canais Kids',kidsFilme:'Filmes Kids',kidsSerie:'S√©ries Kids'}[k];
}

/* ========== ROUTER ========== */
function route(key){
  CUR=key; $('.ativo')?.classList.remove('ativo'); $(`[data_key="${key}"]`)?.classList.add('ativo');
  $('#content').innerHTML='';
  if(key==='tv'||key==='kidsCanais') return gridTV(DATA[key],key);
  if(key==='cont') return gridContinue();
  if(key==='filme'||key==='serie'||key==='kidsFilme'||key==='kidsSerie') return gridMidia(DATA[key],key);
  if(key==='fav') return gridMidia(DATA[key],key);
}

/* ========== GRIDS ========== */
function gridTV(arr,key){
  const cats = groupByCat(arr); // agrupa por #EXTINF group-title
  for(const[c,items] of Object.entries(cats)){
    const row = document.createElement('div'); row.className='row'; row.dataset_cat=c;
    row.style.display='flex'; row.style.overflowX='auto'; row.style.marginBottom='14px';
    items.slice(0,49).forEach((ch,i)=>{
      const card=document.createElement('div'); card.className='card'; card.tabIndex=0;
      card.innerHTML=`<img class=poster src="${ch.logo}" alt="${ch.name}" onerror="this.src='https://via.placeholder.com/200x200.png?text=SEM+LOGO'">
                      <div class=info><b>${ch.name}</b></div>`;
      card.dataset_url=ch.url; card.dataset_title=ch.name;
      row.appendChild(card);
    });
    $('#content').appendChild(row);
  }
}
function gridMidia(arr,key){
  const kids = key.includes('kids');
  if(!kids) renderCatFloat();
  const sorted = kids ? arr.sort((a,b)=>a.titulo.localeCompare(b.titulo)) : arr;
  sorted.forEach(item=>{
    const card=document.createElement('div'); card.className='card'; card.tabIndex=0;
    card.innerHTML=`<img class=poster src="${item.poster}" alt="${item.titulo}">
      <div class=info>
        <div class=year-rating><span>${item.year}</span><span>‚≠ê${item.rating}</span></div>
        <div>${item.titulo}</div>
      </div>`;
    card.dataset_item=JSON.stringify(item);
    $('#content').appendChild(card);
  });
}
function gridContinue(){
  const arr = CONTINUE.filter(x=>Date.now()-x.time<86400000); // 24h
  SS('continue',arr);
  if(!arr.length){ $('#content').innerHTML='<p style="padding:20px;">Nada por aqui ainda.</p>'; return;}
  arr.forEach(x=>{ // recria card
    const card=document.createElement('div'); card.className='card'; card.tabIndex=0;
    card.innerHTML=`<img class=poster src="${x.poster}" alt="${x.titulo}">
      <div class=info>
        <div>Continuar assistindo</div>
        <div>${x.titulo}</div>
      </div>`;
    card.dataset_item=JSON.stringify(x.item);
    $('#content').appendChild(card);
  });
}

/* ========== CAT FLOAT ========== */
function renderCatFloat(){
  const float=$('#catFloat'); float.innerHTML='';
  CATS.forEach(c=>{
    const b=document.createElement('button'); b.textContent=c;
    b.onclick=()=>filterCat(c);
    float.appendChild(b);
  });
}
function filterCat(c){
  $$('.card').forEach(card=>{
    const item=JSON.parse(card.dataset_item||'{}');
    card.style.display=(item.genero===c||c==='Todos')?'block':'none';
  });
  $('#catFloat').classList.remove('show');
}

/* ========== EVENTA / NAVEGA√á√ÉO ========== */
function hookEvents(){
  /* global nav */
  document.addEventListener('keydown',e=>{
    const k=e.key;
    if(k==='ArrowDown'||k==='ArrowUp'||k==='ArrowLeft'||k==='ArrowRight'||k==='Enter'){
      e.preventDefault();
      moveFocus(k);
    }
    if(k==='Backspace' && PLAYER_WRAP.classList.contains('active')){ closePlayer();}
    if(k==='Escape') $('#exitBtn').click();
    if(k==='ChannelDown'||k==='ArrowDown'){ if(CUR==='tv'||CUR==='kidsCanais') nextCh(-1);}
    if(k==='ChannelUp'||k==='ArrowUp'){ if(CUR==='tv'||CUR==='kidsCanais') nextCh(1);}
  });
  /* touch / mouse */
  let lastX,lastY;
  document.addEventListener('touchstart',e=>{lastX=e.touches[0].clientX;lastY=e.touches[0].clientY;});
  document.addEventListener('touchmove',e=>{
    const dx=e.touches[0].clientX-lastX, dy=e.touches[0].clientY-lastY;
    if(Math.abs(dy)>50){ nextCh(dy>0?1:-1); e.preventDefault();}
  });
  /* clicks */
  $('#content').addEventListener('click',e=>{
    const card=e.target.closest('.card');
    if(card){ selectCard(card); }
  });
  /* search */
  $('#globalSearch').addEventListener('input',e=>{
    const term=e.target.value.toLowerCase();
    $$('.card').forEach(c=>{
      const txt=c.textRepresentation||c.textContent.toLowerCase();
      c.style.display=txt.includes(term)?'block':'none';
    });
  });
  /* exit */
  $('#exitBtn').addEventListener('click',()=>{window.history.back();window.close();window.open('about:blank','_self').close();});
  $('#exitPlayer').addEventListener('click',closePlayer);
  /* menu */
  $('#menu').addEventListener('click',e=>{
    const item=e.target.closest('.item');
    if(item){ route(item.dataset_key); }
  });
  /* cat menu */
  $('#content').addEventListener('contextmenu',e=>{
    if(!CUR.includes('kids') && (CUR==='filme'||CUR==='serie')){$('#catFloat').classList.toggle('show'); e.preventDefault();}
  });
  /* keep player controls */
  let hideT;
  const showControls=()=>{$('#exitPlayer').style.opacity=1; clearTimeout(hideT); hideT=setTimeout(()=>{$('#exitPlayer').style.opacity=0;},3000);};
  PLAYER_WRAP.addEventListener('mousemove',showControls);
  PLAYER_WRAP.addEventListener('touchstart',showControls);
  PLAYER_WRAP.addEventListener('keydown',showControls);
}

/* ========== FOCUS / MOVE ========== */
function moveFocus(k){
  const cards=[...$$('.card')].filter(c=>c.offsetWidth); // vis√≠veis
  if(!cards.length) return;
  let idx = cards.findIndex(c=>c===document.activeElement);
  if(idx<0) idx=0;
  if(k==='ArrowRight') idx=(idx+1)%cards.length;
  if(k==='ArrowLeft') idx=(idx-1+cards.length)%cards.length;
  if(k==='ArrowDown') idx=Math.min(idx+7,cards.length-1);
  if(k==='ArrowUp') idx=Math.max(idx-7,0);
  cards[idx].focus();
}
function selectCard(card){
  const url=card.dataset_url;
  const item=JSON.parse(card.dataset_item||'{}');
  if(url){ // tv
    play(url,card.dataset_title);
  }else if(item.type==='movie'||item.type===undefined){
    play(item.url,item.titulo);
    saveContinue(item);
  }else if(item.type==='serie'){
    openSerie(item);
  }
}
function play(src,title){
  $('#playerTitle').textContent=title;
  PLAYER.src=src;
  PLAYER_WRAP.style.display='flex';
  PLAYER_WRAP.classList.add('active');
  PLAYER.play();
}
function closePlayer(){
  PLAYER.pause();
  PLAYER_WRAP.style.display='none';
  PLAYER_WRAP.classList.remove('active');
}
function saveContinue(item){
  const obj={item,time:Date.now(),poster:item.poster,titulo:item.titulo};
  const arr=LS('continue').filter(x=>x.item.url!==item.url);
  arr.push(obj);
  SS('continue',arr);
}
function openSerie(item){
  // busca epis√≥dios no archive identifier
  const wrap=document.createElement('div'); wrap.className='serieep';
  wrap.innerHTML=`<h2>${item.titulo} ‚Äì Epis√≥dios</h2><div class=content></div>`;
  $('#content').innerHTML=''; $('#content').appendChild(wrap);
  // exemplo est√°tico ‚Äì voc√™ pode fazer fetch din√¢mico
  for(let ep=1;ep<=5;ep++){
    const card=document.createElement('div'); card.className='card'; card.tabIndex=0;
    card.innerHTML=`<img class=poster src="${item.poster}" alt="Ep ${ep}">
      <div class=info><div>Epis√≥dio ${ep}</div></div>`;
    card.dataset_url=`https://archive.org/download/${item.identificador_archive}/ep${ep}.mp4`;
    card.dataset_title=`${item.titulo} ‚Äì Ep ${ep}`;
    wrap.querySelector('.content').appendChild(card);
  }
}

/* ========== HELPERS TV ========== */
function nextCh(dir){
  const cards=[...$$('.card')].filter(c=>c.offsetWidth);
  if(!cards.length) return;
  let idx=cards.findIndex(c=>c===document.activeElement);
  if(idx<0) idx=0;
  idx=(idx+dir+cards.length)%cards.length;
  cards[idx].focus(); cards[idx].click();
}
function groupByCat(arr){
  const g={};
  arr.forEach(ch=>{
    const cat = ch.group||'Outros';
    (g[cat]=g[cat]||[]).push(ch);
  });
  return g;
}

/* ========== CLOCK ========== */
function startClock(){
  const tick=()=>{
    const now=new Date();
    const days=['Domingo','Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado'];
    const str=`${days[now.getDay()]}, ${now.toLocaleDateString('pt-BR')} | ${now.toLocaleTimeString('pt-BR',{hour12:false})}`;
    $('#clock').textContent=str;
  };
  tick(); setInterval(tick,1000);
}

/* ========== SERVICE WORKER OFFLINE ========== */
if('serviceWorker' in navigator){
  const sw=`
  self.addEventListener('install',e=>e.waitUntil(self.skipWaiting()));
  self.addEventListener('fetch',e=>e.respondWith(fetch(e.request).catch(()=>new Response('off'))));
  `;
  const blob = new Blob([sw],{type:'application/javascript'});
  const url = URL.createObjectURL(blob);
  navigator.serviceWorker.register(url);
}

/* ========== BLOCK DOWNLOAD ========== */
document.addEventListener('contextmenu',e=>e.preventDefault());
document.addEventListener('selectstart',e=>e.preventDefault());
document.onkeydown=e=>{if(e.ctrlKey&&e.key==='s')e.preventDefault();};
</script>
</body>
</html>
