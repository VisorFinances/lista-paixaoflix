<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAIXÃOFLIX IPTV</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e50914; --bg: #000000; --side-bg: #111111; --text: #ffffff; }
        
        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Roboto', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 0;
            display: flex; 
            height: 100vh; 
            width: 100vw;
            overflow: hidden; 
        }

        /* Menu Lateral Fixo */
        #sidebar { 
            width: 320px; 
            min-width: 320px;
            background: var(--side-bg); 
            display: flex; 
            flex-direction: column; 
            height: 100vh;
            border-right: 1px solid #222;
        }

        .brand { 
            padding: 20px; 
            font-size: 24px; 
            font-weight: bold; 
            color: var(--primary); 
            text-align: center;
            border-bottom: 1px solid #222;
        }

        .search-area { padding: 15px; }
        .search-box { 
            width: 100%; 
            padding: 12px; 
            border-radius: 5px; 
            border: 1px solid #333; 
            background: #222; 
            color: white; 
            outline: none; 
        }

        #channel-list { 
            flex: 1; 
            overflow-y: auto; 
            padding-bottom: 20px;
        }

        .cat-title {
            background: #1a1a1a;
            padding: 10px 15px;
            font-size: 12px;
            text-transform: uppercase;
            color: #888;
            letter-spacing: 1px;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .channel-item { 
            display: flex; 
            align-items: center; 
            padding: 10px 15px; 
            cursor: pointer; 
            transition: 0.2s;
            border-bottom: 1px solid #1a1a1a;
        }
        .channel-item:hover { background: #222; }
        .channel-item img { 
            width: 45px; 
            height: 45px; 
            border-radius: 4px; 
            margin-right: 12px; 
            object-fit: cover;
            background: #000;
        }
        .channel-name { font-size: 14px; font-weight: 400; }

        /* Área do Player (Direita) */
        #main-view { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background: #000;
            position: relative;
        }

        #player-wrapper { 
            flex: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center;
        }

        video { 
            width: 100%; 
            height: 100%; 
            max-height: 100vh;
            background: #000;
        }

        .player-info {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 30px;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            pointer-events: none;
        }
        #current-playing { font-size: 24px; font-weight: bold; margin: 0; }

        /* Scrollbar customizada */
        #channel-list::-webkit-scrollbar { width: 6px; }
        #channel-list::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; height: 40vh; min-width: 100%; }
            #main-view { height: 60vh; }
        }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="brand">PAIXÃOFLIX</div>
    <div class="search-area">
        <input type="text" id="searchInput" class="search-box" placeholder="Pesquisar canal..." onkeyup="filter()">
    </div>
    <div id="channel-list">
        <p style="padding:20px; text-align:center; color:#555;">Sincronizando lista...</p>
    </div>
</div>

<div id="main-view">
    <div id="player-wrapper">
        <video id="video" controls autoplay playsinline></video>
    </div>
    <div class="player-info">
        <p id="current-playing">Selecione um conteúdo</p>
    </div>
</div>

<script>
    const TMDB_KEY = 'b275ce8e1a6b3d5d879bb0907e4f56ad';
    const m3uUrl = '/tv.paixaoflix.m3u?v=' + Date.now();
    const video = document.getElementById('video');
    let masterData = {};

    async function start() {
        try {
            const res = await fetch(m3uUrl);
            const data = await res.text();
            if(!data.includes("#EXTINF")) throw "Erro";
            parse(data);
        } catch (e) {
            document.getElementById('channel-list').innerHTML = "<p style='color:red; padding:20px;'>Erro ao carregar lista. Verifique seu Worker.</p>";
        }
    }

    function parse(text) {
        const lines = text.split('\n');
        let categories = {};
        for (let i = 0; i < lines.length; i++) {
            if (lines[i].includes('#EXTINF')) {
                const title = lines[i].split(',')[1]?.trim();
                const url = lines[i+1]?.trim();
                const group = lines[i].match(/group-title="([^"]+)"/)?.[1] || "Geral";
                if (url && url.startsWith('http')) {
                    if (!categories[group]) categories[group] = [];
                    categories[group].push({ title, url });
                }
            }
        }
        masterData = categories;
        render(categories);
    }

    function render(data) {
        const list = document.getElementById('channel-list');
        list.innerHTML = '';
        for (let cat in data) {
            const head = document.createElement('div');
            head.className = 'cat-title';
            head.innerText = cat;
            list.appendChild(head);

            data[cat].forEach(item => {
                const id = btoa(encodeURIComponent(item.title)).substring(0,10).replace(/[^a-z]/gi, 'x');
                const div = document.createElement('div');
                div.className = 'channel-item';
                div.innerHTML = `
                    <img src="https://via.placeholder.com/80x120/111/333?text=TV" id="img-${id}">
                    <div class="channel-name">${item.title}</div>
                `;
                div.onclick = () => play(item.url, item.title);
                list.appendChild(div);
                loadImg(item.title, id);
            });
        }
    }

    async function loadImg(title, id) {
        let q = title.replace(/E\.P\.C/gi, 'Eu a Patroa e as Crianças').replace(/S\d+E\d+|720p|1080p|HD|By-.*/gi, '').trim();
        try {
            const r = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${TMDB_KEY}&language=pt-BR&query=${encodeURIComponent(q)}`);
            const j = await r.json();
            if (j.results && j.results[0]?.poster_path) {
                document.getElementById(`img-${id}`).src = `https://image.tmdb.org/t/p/w200${j.results[0].poster_path}`;
            }
        } catch (e) {}
    }

    function play(url, title) {
        document.getElementById('current-playing').innerText = title;
        let finalUrl = url.startsWith('http:') ? `/proxy?url=${encodeURIComponent(url)}` : url;

        if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(finalUrl);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        } else {
            video.src = finalUrl;
            video.play();
        }
    }

    function filter() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        let filtered = {};
        for (let cat in masterData) {
            let m = masterData[cat].filter(i => i.title.toLowerCase().includes(q));
            if (m.length > 0) filtered[cat] = m;
        }
        render(filtered);
    }

    start();
</script>

</body>
</html>
