<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>PaixãFlix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #000; color: #fff; font-family: Arial, sans-serif; overflow: hidden; }
    .sidebar { position: fixed; left: 0; top: 0; width: 80px; height: 100vh; background: #111; display: flex; flex-direction: column; align-items: center; padding-top: 20px; z-index: 10; }
    .sidebar img.logo { width: 50px; cursor: pointer; }
    .sidebar .icon { width: 30px; margin: 20px 0; cursor: pointer; filter: brightness(0.8); transition: 0.2s; }
    .sidebar .icon:hover { filter: brightness(1.2); }
    .topbar { position: fixed; top: 0; left: 80px; right: 0; height: 60px; background: #0a0a0a; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 9; }
    .topbar .counter { font-size: 18px; }
    .topbar .datetime { font-size: 14px; }
    .main { margin-left: 80px; margin-top: 60px; padding: 20px; }
    .section { margin-bottom: 40px; }
    .section h2 { margin-bottom: 10px; }
    .row { display: flex; gap: 10px; overflow-x: auto; scroll-behavior: smooth; }
    .card { min-width: 200px; background: #1a1a1a; border-radius: 8px; position: relative; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(255, 193, 7, 0.3); }
    .card img { width: 100%; border-radius: 8px 8px 0 0; }
    .card .info { padding: 8px; font-size: 12px; display: flex; justify-content: space-between; }
    .card .number { position: absolute; top: 5px; left: 5px; background: #003d82; border: 2px solid #ffc107; color: #fff; padding: 4px 8px; border-radius: 50%; font-weight: bold; }
    .card:focus { outline: 3px solid #ffc107; }
    .player { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 100; display: none; }
    .player video { width: 100%; height: 100%; }
    .player .exit { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.1); border: none; color: #fff; padding: 10px 20px; cursor: pointer; border-radius: 4px; }
    .search-results { display: none; position: fixed; top: 60px; left: 80px; right: 0; bottom: 0; background: #000; z-index: 8; padding: 20px; overflow-y: auto; }
  </style>
</head>
<body>

<div class="sidebar">
  <img src="https://raw.githubusercontent.com/VisorFinances/lista-paixaoflix/refs/heads/main/logoof512.png" class="logo" onclick="location.reload()">
  <img src="https://img.icons8.com/ios-filled/50/ffffff/search.png" class="icon" onclick="toggleSearch()">
  <img src="https://img.icons8.com/ios-filled/50/ffffff/film-reel.png" class="icon" onclick="loadPage('cinema')">
  <img src="https://img.icons8.com/ios-filled/50/ffffff/tv-show.png" class="icon" onclick="loadPage('series')">
  <img src="https://img.icons8.com/ios-filled/50/ffffff/tv.png" class="icon" onclick="loadPage('tv')">
  <img src="https://img.icons8.com/ios-filled/50/ffffff/children.png" class="icon" onclick="loadPage('kids_filmes')">
  <img src="https://img.icons8.com/ios-filled/50/ffffff/animation.png" class="icon" onclick="loadPage('kids_series')">
  <img src="https://img.icons8.com/ios-filled/50/ffffff/like.png" class="icon" onclick="loadPage('favoritos')">
</div>

<div class="topbar">
  <div class="counter">Estamos evoluindo: <span id="total">0</span></div>
  <div class="datetime" id="datetime"></div>
</div>

<div class="search-results" id="searchResults"></div>

<div class="main" id="main">
  <div class="section">
    <h2>PaixãFlix indica hoje</h2>
    <div class="row" id="top4"></div>
  </div>
  <div class="section">
    <h2>Continuar assistindo</h2>
    <div class="row" id="continue"></div>
  </div>
</div>

<div class="player" id="player">
  <video id="videoPlayer" controls autoplay></video>
  <button class="exit" onclick="exitPlayer()">Sair</button>
</div>

<script>
const dataFiles = {
  cinema: 'data/filmes.json',
  series: 'data/series.json',
  kids_filmes: 'data/kids_filmes.json',
  kids_series: 'data/kids_series.json',
  favoritos: 'data/favoritos.json',
  tv: 'data/ativa_kids_canais.m3u'
};

let allData = {};
let continueWatching = JSON.parse(localStorage.getItem('continue') || '[]');
let currentPage = 'home';

function loadData(url) {
  return fetch(url).then(r => r.json()).catch(() => []);
}

async function init() {
  updateDateTime();
  setInterval(updateDateTime, 1000);
  await loadAllData();
  renderTop4();
  renderContinue();
  updateCounter();
}

async function loadAllData() {
  const keys = Object.keys(dataFiles);
  for (let k of keys) {
    if (k === 'tv') continue;
    allData[k] = await loadData(dataFiles[k]);
  }
}

function updateDateTime() {
  const now = new Date();
  const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
  document.getElementById('datetime').textContent = now.toLocaleString('pt-BR', opts);
}

function updateCounter() {
  let total = 0;
  Object.values(allData).forEach(arr => total += arr.length);
  document.getElementById('total').textContent = total;
}

function renderTop4() {
  const container = document.getElementById('top4');
  container.innerHTML = '';
  const pool = [
    ...allData.cinema || [],
    ...allData.series || [],
    ...allData.kids_filmes || [],
    ...allData.kids_series || []
  ];
  const picked = pool.sort(() => 0.5 - Math.random()).slice(0, 4);
  picked.forEach((item, idx) => {
    const card = createCard(item, idx + 1);
    card.onclick = () => goDetail(item);
    container.appendChild(card);
  });
}

function renderContinue() {
  const container = document.getElementById('continue');
  container.innerHTML = '';
  continueWatching.forEach(item => {
    const card = createCard(item);
    card.onclick = () => playContent(item, item.progress || 0);
    container.appendChild(card);
  });
}

function createCard(item, number) {
  const div = document.createElement('div');
  div.className = 'card';
  div.tabIndex = 0;
  div.innerHTML = `
    ${number ? `<div class="number">${number}</div>` : ''}
    <img src="${item.poster}" alt="${item.title}">
    <div class="info">
      <span>${item.year}</span>
      <span>⭐ ${item.rating}</span>
      <span>${item.category}</span>
    </div>
  `;
  return div;
}

function goDetail(item) {
  localStorage.setItem('detail', JSON.stringify(item));
  location.href = '#detail';
  const main = document.getElementById('main');
  main.innerHTML = `
    <div style="position:relative;">
      <img src="${item.backdrop}" style="position:absolute;opacity:.1;width:100%;z-index:0;">
      <div style="display:flex;align-items:center;z-index:1;position:relative;">
        <img src="${item.poster}" style="width:200px;">
        <div style="margin-left:20px;">
          <h1>${item.title}</h1>
          <p>${item.year}  ⭐ ${item.rating}</p>
          <p>${item.description}</p>
          <button class="exit" onclick="playContent(${JSON.stringify(item).replace(/"/g,'"')})">Assistir Agora</button>
          <button class="exit" onclick="loadPage('${item.type === 'serie' ? 'series' : 'cinema'}')">Voltar</button>
        </div>
      </div>
      ${item.episodes ? `
        <h2>Episódios</h2>
        <div class="row">
          ${item.episodes.slice(0,10).map((ep,i)=>`
            <div class="card" tabindex="0" onclick="playContent(${JSON.stringify({...item, episode:i, url:ep})})">
              <img src="${item.poster}"><div class="info"><span>Ep ${i+1}</span></div>
            </div>
          `).join('')}
        </div>
      ` : ''}
    </div>
  `;
}

function playContent(item, start = 0) {
  const player = document.getElementById('player');
  const video = document.getElementById('videoPlayer');
  video.src = item.url;
  video.currentTime = start;
  player.style.display = 'block';
  video.play();
  video.onended = () => {
    if (item.episode !== undefined && item.episodes && item.episode < item.episodes.length - 1) {
      setTimeout(() => {
        playContent({...item, episode: item.episode + 1, url: item.episodes[item.episode + 1]});
      }, 5000);
    } else {
      exitPlayer();
    }
  };
  video.ontimeupdate = () => {
    item.progress = video.currentTime;
    let list = continueWatching.filter(x => x.title !== item.title);
    list.unshift(item);
    continueWatching = list.slice(0, 20);
    localStorage.setItem('continue', JSON.stringify(continueWatching));
  };
}

function exitPlayer() {
  document.getElementById('player').style.display = 'none';
  document.getElementById('videoPlayer').pause();
}

async function loadPage(page) {
  currentPage = page;
  const main = document.getElementById('main');
  if (page === 'tv') {
    const m3u = await fetch(dataFiles.tv).then(r => r.text()).catch(() => '');
    const lines = m3u.split('\n').filter(l => l.includes('tvg-logo'));
    const channels = lines.map(l => {
      const name = l.match(/tvg-name="([^"]+)"/)?.[1] || 'Canal';
      const logo = l.match(/tvg-logo="([^"]+)"/)?.[1] || '';
      const url = lines[lines.indexOf(l)+1];
      return {name, logo, url};
    });
    main.innerHTML = '<h2>Canais Ao Vivo</h2>' + channels.map(ch=>`
      <div class="card" tabindex="0" style="display:flex;align-items:center;gap:10px;min-width:250px;" onclick="playContent(${JSON.stringify(ch)})">
        <img src="${ch.logo}" style="width:40px;height:40px;">
        <span>${ch.name}</span>
      </div>
    `).join('');
    return;
  }
  const data = allData[page] || [];
  const grouped = {};
  data.forEach(item => {
    const cat = item.category || 'Outros';
    if (!grouped[cat]) grouped[cat] = [];
    grouped[cat].push(item);
  });
  main.innerHTML = Object.entries(grouped).map(([cat, items]) => `
    <h2>${cat}</h2>
    <div class="row">
      ${items.map(item=>createCard(item).outerHTML).join('')}
    </div>
  `).join('');
}

function toggleSearch() {
  const sr = document.getElementById('searchResults');
  sr.style.display = sr.style.display === 'block' ? 'none' : 'block';
  if (sr.style.display === 'block') {
    sr.innerHTML = '<input type="text" placeholder="Digite para buscar..." style="width:100%;padding:10px;font-size:18px;" oninput="realtimeSearch(this.value)">';
  }
}

function realtimeSearch(q) {
  if (!q) return;
  const res = [];
  Object.values(allData).flat().forEach(item => {
    if (item.title.toLowerCase().includes(q.toLowerCase())) res.push(item);
  });
  const sr = document.getElementById('searchResults');
  sr.innerHTML = '<input type="text" placeholder="Digite para buscar..." style="width:100%;padding:10px;font-size:18px;" oninput="realtimeSearch(this.value)">' +
    res.map(item => createCard(item).outerHTML).join('');
}

document.addEventListener('keydown', e => {
  const f = document.querySelector(':focus');
  if (!f) return;
  const row = f.parentElement;
  const idx = Array.from(row.children).indexOf(f);
  if (e.key === 'ArrowRight' && f.nextElementSibling) f.nextElementSibling.focus();
  if (e.key === 'ArrowLeft' && f.previousElementSibling) f.previousElementSibling.focus();
  if (e.key === 'ArrowDown' && row.parentElement.nextElementSibling) {
    const nextRow = row.parentElement.nextElementSibling.querySelector('.row');
    if (nextRow && nextRow.children[idx]) nextRow.children[idx].focus();
  }
  if (e.key === 'ArrowUp' && row.parentElement.previousElementSibling) {
    const prevRow = row.parentElement.previousElementSibling.querySelector('.row');
    if (prevRow && prevRow.children[idx]) prevRow.children[idx].focus();
  }
});

init();
</script>
</body>
</html>
