<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>PaixãoFlix TV</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; overflow: hidden; -webkit-tap-highlight-color: transparent; }
body { background: #000; color: #fff; font-family: 'Poppins', sans-serif; height: 100vh; width: 100vw; }
#layout-principal { display: flex; height: 100%; width: 100%; background: #000; }

/* --- MENU LATERAL --- */
#barra-menu { width: 180px; background: #001a1a; border-right: 2px solid #003333; display: flex; flex-direction: column; z-index: 100; flex-shrink: 0; }
#header-logo { padding: 15px 10px; text-align: center; }
#header-logo img { height: 80px; width: auto; max-width: 100%; object-fit: contain; }
#relogio { font-size: 10px; color: #00ffcc; margin-top: 5px; text-align: center; }

#searchBox { padding: 0 10px 15px; }
#searchInput { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #003333; background: #000; color: #fff; outline: none; font-size: 12px; }

#itens-menu { flex: 1; padding: 10px; overflow-y: auto; }
.item-clicavel { padding: 10px; font-size: 12px; margin-bottom: 8px; border-radius: 8px; background: #0080ff; border-bottom: 3px solid #004d99; display: flex; align-items: center; cursor: pointer; color: #fff; }
.item-clicavel.selecionado { background: #fff !important; color: #000 !important; font-weight: bold; }

/* --- ÁREA DO PLAYER --- */
#area-player { flex: 1; position: relative; background: #000; display: flex; align-items: center; justify-content: center; }
#meu-video { width: 100%; height: 100%; object-fit: contain; background: #000; }

/* BOTÃO SAIR SOBRE O VÍDEO */
#btn-sair-player { position: absolute; top: 20px; right: 20px; background: rgba(255, 0, 0, 0.8); color: white; border: none; padding: 12px 25px; border-radius: 5px; font-weight: bold; cursor: pointer; z-index: 1000; display: none; text-transform: uppercase; font-size: 14px; }

#painel-conteudo { position: absolute; left: 0; top: 0; height: 100%; background: rgba(0,0,0,0.98); z-index: 50; display: none; width: 100%; }

#lista-canais { width: 240px; height: 100%; border-right: 1px solid #111; overflow-y: auto; background: #000; flex-shrink: 0; }
.canal-item { padding: 12px 15px; font-size: 13px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; color: #ccc; background: #000; }
.canal-item.ativo { background: #111 !important; color: #00ffcc !important; border-left: 4px solid #00ffcc; }
.canal-item.categoria-header { background: #002222; color: #00ffcc; font-weight: bold; }

#container-capa { padding: 0 20px; display: flex; align-items: center; justify-content: center; flex: 1; background: #000; }
#imagem-capa { height: 350px; width: auto; border-radius: 10px; border: 3px solid #00ffcc; cursor: pointer; box-shadow: 0 0 20px rgba(0,255,204,0.3); }

/* MODAL VOD */
#modal-vod { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #001a1a; padding: 25px; border: 2px solid #00ffcc; z-index: 200; display: none; border-radius: 15px; text-align: center; }
.btn-vod { padding: 10px 20px; margin: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
#btn-continuar { background: #00ffcc; color: #000; }
#btn-recomecar { background: #ff3333; color: #fff; }

@media (max-width: 850px) {
    #barra-menu { width: 100px; }
    #lista-canais { width: 140px; }
    #imagem-capa { height: 220px; }
}
</style>
</head>
<body id="body-main">

<div id="layout-principal">
    <div id="barra-menu">
        <div id="header-logo">
            <img src="https://raw.githubusercontent.com/VisorFinances/lista-paixaoflix/refs/heads/main/logoof512.png">
            <div id="relogio"></div>
        </div>
        <div id="searchBox"><input type="text" id="searchInput" placeholder="Busca Global..."></div>
        <div id="itens-menu">
            <div class="item-clicavel selecionado" data-type="m3u" data-url="https://raw.githubusercontent.com/VisorFinances/lista-paixaoflix/refs/heads/main/data/ativa_canais.m3u"><i class="fas fa-tv"></i> Canais</div>
            <div class="item-clicavel" data-type="fav"><i class="fas fa-star"></i> Favoritos</div>
            <div class="item-clicavel" data-type="json" data-url="https://raw.githubusercontent.com/VisorFinances/lista-paixaoflix/refs/heads/main/data/filmes.json"><i class="fas fa-film"></i> Cinema</div>
            <div class="item-clicavel" data-type="json" data-url="https://raw.githubusercontent.com/VisorFinances/lista-paixaoflix/refs/heads/main/data/series.json"><i class="fas fa-clapperboard"></i> Séries</div>
            <div class="item-clicavel" data-type="m3u" data-url="https://raw.githubusercontent.com/VisorFinances/lista-paixaoflix/refs/heads/main/data/ativa_kids_canais.m3u"><i class="fas fa-child"></i> Kids TV</div>
            <div class="item-clicavel" data-type="json" data-url="https://raw.githubusercontent.com/VisorFinances/lista-paixaoflix/refs/heads/main/data/kids_filmes.json"><i class="fas fa-icons"></i> Kids Cine</div>
            <div class="item-clicavel" data-type="json" data-url="https://raw.githubusercontent.com/VisorFinances/lista-paixaoflix/refs/heads/main/data/kids_series.json"><i class="fas fa-robot"></i> Kids Séries</div>
        </div>
    </div>

    <div id="area-player">
        <video id="meu-video" playsinline></video>
        <button id="btn-sair-player" onclick="fecharPlayer()">Sair</button>
        <div id="painel-conteudo">
            <div id="lista-canais"></div>
            <div id="container-capa"><img id="imagem-capa" src=""></div>
        </div>
    </div>
</div>

<div id="modal-vod">
    <h3 style="margin-bottom:15px">Continuar Assistindo?</h3>
    <button id="btn-continuar" class="btn-vod">Continuar</button>
    <button id="btn-recomecar" class="btn-vod">Reiniciar</button>
</div>

<script>
const video = document.getElementById("meu-video");
const btnSair = document.getElementById("btn-sair-player");
const painelConteudo = document.getElementById("painel-conteudo");
const listaCanaisDiv = document.getElementById("lista-canais");
const imgCapa = document.getElementById("imagem-capa");
const menuItems = document.querySelectorAll('.item-clicavel');
const searchInput = document.getElementById("searchInput");
const modalVod = document.getElementById("modal-vod");

let rawData = [], currentDisplayData = [], currentItem = null;
let menuIndex = 0, itemIndex = 0, menuFocused = true, hls = null;
let favoritos = JSON.parse(localStorage.getItem('paixaoflix_favs')) || [];
let historico = JSON.parse(localStorage.getItem('paixaoflix_history')) || {};
let globalDB = [];

// RELÓGIO EXATO: terça, 13 jan 26 | 23:21
function updateClock() {
    const d = new Date();
    const dias = ["domingo", "segunda", "terça", "quarta", "quinta", "sexta", "sábado"];
    const meses = ["jan", "fev", "mar", "abr", "mai", "jun", "jul", "ago", "set", "out", "nov", "dez"];
    const pad = (n) => String(n).padStart(2, '0');
    document.getElementById("relogio").innerText = `${dias[d.getDay()]}, ${pad(d.getDate())} ${meses[d.getMonth()]} ${String(d.getFullYear()).slice(-2)} | ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
setInterval(updateClock, 1000); updateClock();

// CONTROLE DO BOTÃO SAIR
let timeoutSair;
function mostrarBotaoSair() {
    if(video.paused && !video.currentTime) return;
    btnSair.style.display = "block";
    clearTimeout(timeoutSair);
    timeoutSair = setTimeout(() => { btnSair.style.display = "none"; }, 4000);
}
video.parentElement.onclick = mostrarBotaoSair;
video.parentElement.onmousemove = mostrarBotaoSair;

function fecharPlayer() {
    video.pause();
    video.src = "";
    if(hls) hls.destroy();
    btnSair.style.display = "none";
    painelConteudo.style.display = "block";
    menuFocused = false;
}

// BUSCA GLOBAL
async function initGlobalSearch() {
    const urls = Array.from(menuItems).map(i => i.dataset.url).filter(u => u);
    for (const url of urls) {
        try {
            const res = await fetch(url);
            if (url.includes('.m3u')) {
                const text = await res.text();
                let temp = null;
                text.split('\n').forEach(line => {
                    if (line.startsWith('#EXTINF')) temp = { titulo: line.split(',').pop().trim(), isLive: true };
                    else if (line.startsWith('http') && temp) { temp.url = line.trim(); globalDB.push(temp); temp = null; }
                });
            } else {
                const json = await res.json();
                const items = json.categories ? json.categories.flatMap(c => c.items) : json;
                items.forEach(i => { i.isLive = false; globalDB.push(i); });
            }
        } catch(e) {}
    }
}
initGlobalSearch();

async function carregarDados(btn) {
    const response = await fetch(btn.dataset.url);
    if (btn.dataset.type === "m3u") {
        const text = await response.text();
        let items = [], temp = null;
        text.split('\n').forEach(line => {
            if (line.startsWith('#EXTINF')) temp = { titulo: line.split(',').pop().trim(), isLive: true };
            else if (line.startsWith('http') && temp) { temp.url = line.trim(); items.push(temp); temp = null; }
        });
        rawData = items;
    } else { rawData = await response.json(); }
    processarCategorias();
}

function processarCategorias() {
    currentDisplayData = [];
    if (!Array.isArray(rawData) && rawData.categories) {
        rawData.categories.forEach(cat => {
            currentDisplayData.push({ isHeader: true, titulo: cat.name });
            cat.items.forEach(item => { item.isLive = false; currentDisplayData.push(item); });
        });
    } else { currentDisplayData = rawData.map(i => { if(i.isLive === undefined) i.isLive = true; return i; }); }
    itemIndex = 0; renderLista();
}

function renderLista() {
    listaCanaisDiv.innerHTML = "";
    currentDisplayData.forEach((item, i) => {
        const div = document.createElement('div');
        div.className = `canal-item ${i === itemIndex ? 'ativo' : ''} ${item.isHeader ? 'categoria-header' : ''}`;
        div.innerHTML = `<span>${item.titulo || item.name}</span>`;
        if (!item.isHeader) {
            const isFav = favoritos.some(f => (f.url || f.link) === (item.url || item.link));
            div.innerHTML += `<i class="fas fa-star fav-btn ${isFav ? 'active' : ''}" onclick="event.stopPropagation(); toggleFav(${JSON.stringify(item).replace(/"/g, '&quot;')})"></i>`;
            div.onclick = () => { itemIndex = i; renderLista(); };
        }
        listaCanaisDiv.appendChild(div);
        if (i === itemIndex) {
            div.scrollIntoView({ block: 'center' });
            if (!item.isHeader) {
                imgCapa.src = item.poster || item.logo || "";
                imgCapa.onclick = () => { prepararPlay(item); };
            }
        }
    });
}

function prepararPlay(item) {
    const key = item.url || item.link;
    if (!item.isLive && historico[key] > 10) {
        modalVod.style.display = "block";
        document.getElementById("btn-continuar").onclick = () => { modalVod.style.display="none"; playMedia(item, historico[key]); };
        document.getElementById("btn-recomecar").onclick = () => { modalVod.style.display="none"; playMedia(item, 0); };
    } else { playMedia(item, 0); }
}

function playMedia(item, startTime) {
    currentItem = item;
    const url = item.url || item.link;
    if (hls) hls.destroy();
    if (url.includes(".m3u8")) {
        if (Hls.isSupported()) {
            hls = new Hls(); hls.loadSource(url); hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => { if(startTime) video.currentTime = startTime; video.play(); });
        }
    } else {
        video.src = url;
        video.onloadedmetadata = () => { if(startTime) video.currentTime = startTime; video.play(); };
    }
    painelConteudo.style.display = "none";
    if (document.body.requestFullscreen) document.body.requestFullscreen();
}

// NAVEGAÇÃO E TECLAS
document.onkeydown = (e) => {
    const key = e.keyCode || e.which;
    if (key == 13 && !menuFocused) { prepararPlay(currentDisplayData[itemIndex]); return; }
    if (key == 37 && !menuFocused) {
        let prevHeader = -1;
        for(let i = itemIndex; i >= 0; i--) { if(currentDisplayData[i].isHeader) { prevHeader = i; break; } }
        if (itemIndex !== prevHeader && prevHeader !== -1) { itemIndex = prevHeader; renderLista(); } 
        else { menuFocused = true; painelConteudo.style.display = "none"; }
        return;
    }
    if (menuFocused) {
        if (key == 40) menuIndex = (menuIndex + 1) % menuItems.length;
        if (key == 38) menuIndex = (menuIndex - 1 + menuItems.length) % menuItems.length;
        if (key == 13 || key == 39) { 
            menuFocused = false; 
            const btn = menuItems[menuIndex];
            if (btn.dataset.type === "fav") { rawData = favoritos; processarCategorias(); } else carregarDados(btn);
            painelConteudo.style.display = "block";
        }
        menuItems.forEach((m, i) => m.classList.toggle('selecionado', i === menuIndex));
    } else {
        if (key == 40) { itemIndex = (itemIndex + 1) % currentDisplayData.length; renderLista(); }
        if (key == 38) { itemIndex = (itemIndex - 1 + currentDisplayData.length) % currentDisplayData.length; renderLista(); }
    }
};

searchInput.oninput = () => {
    const term = searchInput.value.toLowerCase();
    if (!term) { processarCategorias(); return; }
    currentDisplayData = globalDB.filter(i => (i.titulo || i.name || "").toLowerCase().includes(term));
    itemIndex = 0; renderLista();
};

video.ontimeupdate = () => {
    if (currentItem && !currentItem.isLive && video.currentTime > 5) {
        historico[currentItem.url || currentItem.link] = video.currentTime;
        localStorage.setItem('paixaoflix_history', JSON.stringify(historico));
    }
};

menuItems.forEach((btn, i) => { btn.onclick = () => { menuIndex = i; menuFocused = false; if (btn.dataset.type === "fav") { rawData = favoritos; processarCategorias(); } else carregarDados(btn); painelConteudo.style.display = "block"; }; });
</script>
</body>
</html>
