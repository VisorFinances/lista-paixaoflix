<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>PaixãoFlix TV</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8"></script>

<style>
html,body{margin:0;padding:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;height:100%;overflow:hidden}
#app{display:flex;height:100%}
#menu{width:300px;background:#111;padding:15px;box-sizing:border-box}
.menu-item{padding:14px;margin-bottom:10px;border-radius:8px;background:#222}
.menu-item.active{background:#ff9800;color:#000;font-weight:bold}
#content{flex:1;position:relative;background:#000}
video{width:100%;height:100%;object-fit:contain;background:#000}
#list{position:absolute;left:0;top:0;width:360px;height:100%;background:rgba(0,0,0,.96);display:none;overflow-y:auto}
.item{padding:18px;border-bottom:1px solid #222}
.item.active{background:#ff9800;color:#000;font-weight:bold}
#overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:26px;background:rgba(0,0,0,.6);display:none}
</style>
</head>

<body>
<div id="app">
  <div id="menu">
    <div class="menu-item active">TV AO VIVO</div>
    <div class="menu-item">CINEMA</div>
    <div class="menu-item">SÉRIES</div>
  </div>

  <div id="content">
    <video id="video" autoplay playsinline></video>
    <div id="list"></div>
    <div id="overlay">Carregando…</div>
  </div>
</div>

<script>
/* ================= PLAYER CONTROLLER ================= */
class PlayerController {
  constructor(video){
    this.video = video;
    this.hls = null;
    this.retry = 0;
    this.maxRetry = 5;
  }

  load(url){
    this.cleanup();
    UI.showLoading(true);

    if(url.includes(".m3u8") && Hls.isSupported()){
      this.hls = new Hls({ enableWorker:true, lowLatencyMode:true });
      this.hls.loadSource(url);
      this.hls.attachMedia(this.video);
      this.hls.on(Hls.Events.MANIFEST_PARSED,()=>this.play());
      this.hls.on(Hls.Events.ERROR,()=>this.retryPlay(url));
    } else {
      this.video.src = url;
      this.video.oncanplay = ()=>this.play();
      this.video.onerror = ()=>this.retryPlay(url);
    }
  }

  play(){
    this.video.play().then(()=>{
      UI.showLoading(false);
      this.retry = 0;
    }).catch(()=>this.retryPlay(this.video.src));
  }

  retryPlay(url){
    if(this.retry++ < this.maxRetry){
      setTimeout(()=>this.load(url),500);
    } else {
      UI.showError("Erro ao reproduzir");
    }
  }

  cleanup(){
    if(this.hls){ this.hls.destroy(); this.hls=null }
    this.video.pause();
    this.video.removeAttribute("src");
    this.video.load();
  }
}

/* ================= UI ================= */
const UI = {
  overlay:document.getElementById("overlay"),
  showLoading(v){ this.overlay.style.display = v?"flex":"none"; this.overlay.innerText="Carregando…"; },
  showError(t){ this.overlay.style.display="flex"; this.overlay.innerText=t; }
};

/* ================= INPUT ================= */
class InputController {
  constructor(){
    this.index = 0;
    document.addEventListener("keydown",e=>this.handle(e));
  }
  handle(e){
    if(e.key==="ArrowDown") navigate(1);
    if(e.key==="ArrowUp") navigate(-1);
    if(e.key==="Enter") selectItem();
  }
}

/* ================= DATA ================= */
const listEl=document.getElementById("list");
const video=document.getElementById("video");
const player=new PlayerController(video);
new InputController();

let items=[],selected=0;

function render(){
  listEl.innerHTML="";
  items.forEach((i,idx)=>{
    const d=document.createElement("div");
    d.className="item"+(idx===selected?" active":"");
    d.textContent=i.titulo;
    listEl.appendChild(d);
  });
}

function navigate(dir){
  selected=(selected+dir+items.length)%items.length;
  render();
}

function selectItem(){
  player.load(items[selected].url);
  listEl.style.display="none";
}

/* ================= LOAD M3U ================= */
fetch("data/canais.m3u")
.then(r=>r.text())
.then(t=>{
  let temp=null;
  t.split("\n").forEach(l=>{
    if(l.startsWith("#EXTINF")) temp={titulo:l.split(",").pop()};
    else if(l.startsWith("http") && temp){ temp.url=l; items.push(temp); temp=null; }
  });
  render();
  listEl.style.display="block";
  player.load(items[0].url);
});
</script>
</body>
</html>
